# Memory Controller Analysis - Critical Finding

## Document: TL2_mem_controller.pdf

## CRITICAL DISCOVERY: ROMCS is Hardware Address-Decoded

### From Page 3 (Functional Descriptions):

> "ROMCS* is decoded from A17-A23 and latched by ALE when HLDA is active. The ROM address ranges from 0E0000h to 0FFFFFh for the low address, EE0000h to EFFFFFh and FE0000h to FFFFFFh for high address. This output signal is asserted when any one of the three address ranges is detected and REFRESH* is inactive."

**Key Points:**
- ROMCS is **decoded from address lines A17-A23**
- It's **latched by ALE** (Address Latch Enable)
- Activates for THREE address ranges:
  - **0E0000h-0FFFFFh** (E000:0000-EFFF:FFFF) ← Our target E000 segment!
  - 0xEE0000h-0xEFFFFFh (high memory alias)
  - 0xFE0000h-0xFFFFFFh (F000:0000-FFFF:FFFF - System BIOS)

### From Page 6 (DMA Control Logic Equations):

```
/Bromcs = /la23 & /la22 & /la21 & /la20 & la19 & la18 & la17 & /refresh
         +la23 & la22 & la21 & la20 & la19 & la18 & la17 & /refresh
         +la23 & la22 & la21 & /la20 & la19 & la18 & la17 & /refresh
```

**Decoding the boolean logic:**

Term 1: `/A23 & /A22 & /A21 & /A20 & A19 & A18 & A17`
- Binary: `0000 111` (A23-A17)
- Address range: **0x0E0000 - 0x0FFFFF**
- Segment notation: **E000:0000 - EFFF:FFFF** ← ROM page frame window

Term 2: `A23 & A22 & A21 & A20 & A19 & A18 & A17`
- Binary: `1111 111` (A23-A17)
- Address range: 0xEE0000 - 0xEFFFFF
- High memory alias

Term 3: `A23 & A22 & A21 & /A20 & A19 & A18 & A17`
- Binary: `1110 111` (A23-A17)
- Address range: **0xFE0000 - 0xFFFFFF**
- Segment notation: **F000:0000 - FFFF:FFFF** (System BIOS)

## The Devastating Conclusion

### Port FFEA Does NOT Control ROMCS!

**ROMCS is generated purely by address decoding hardware in the DRAM/DMA Control IC.**

The logic is:
```
IF (CPU addresses E000:0000-EFFF:FFFF)
   AND (NOT in REFRESH cycle)
THEN
   Assert ROMCS (activate ROM chips)
```

### What Port FFEA Actually Does

Port FFEA is connected to the **ROM chips themselves**, not the memory controller's address decoder.

Port FFEA bits 0-3 control:
- **Which 64KB page** (0-7) is visible through the E000 window
- Page selection WITHIN the ROM
- Does NOT control WHETHER the ROM is mapped

Think of it like this:
- **ROMCS**: "Is ROM connected to the bus?" ← Hardware address decode (CANNOT disable)
- **Port FFEA**: "Which page of ROM am I looking at?" ← Software control (CAN change)

## Why Our Testing Failed

### Test Results Explained:

1. **Port FFEA writes didn't disable ROM** because Port FFEA doesn't control ROMCS
2. **E000:0000 always showed ROM data** because ROMCS is always active for E000 addresses
3. **Hardware rejected 0x0F pattern** because it's an invalid page number (only 0-7 valid)
4. **Bit 4 inverted on readback** because it's used for TL/SL system detection, not ROM disable

### The Handwritten Note Was Misunderstood

The note "Writing 1 to bit 4 disables access to ROM segment at E0000" was likely:
- Speculative/wishful thinking
- Misinterpreted documentation
- Referring to a different Tandy model (SL/TL confusion)
- Plain wrong

## Architecture Overview

```
CPU Address Bus (A17-A23)
         |
         v
DRAM/DMA Control IC (U22)
         |
         ├──> ROMCS# ────> ROM Chips (U54-U57) ← ALWAYS active for E000 addresses
         |
         └──> Address Decode Logic (Hardwired)
```

Port FFEA is separate:
```
Port FFEA (I/O address 0xFFEA)
         |
         v
    Page Register ──> ROM Address Lines (select which 64KB page)
```

## Implications for Project

### The Bad News: Software Solution is IMPOSSIBLE

**There is NO software method to disable ROM at E000:0000.**

The ROMCS signal is:
- Generated by hardware address decode logic
- Hardwired in the DRAM/DMA Control IC
- Cannot be overridden by Port FFEA or any other I/O port
- Activated automatically whenever CPU accesses E000-EFFF

### Why EMM386 Cannot Use E000-EFFF

When EMM386 tries to map RAM at E000:
1. CPU generates address E000:xxxx
2. Memory controller decodes A17-A23 = 0000111b
3. ROMCS goes active
4. ROM chips respond to the address
5. RAM at E000 is shadowed/blocked by ROM

**The ROM physically blocks access to RAM at E000.**

## Possible Solutions (All Require Hardware Modification)

### Solution 1: Cut ROMCS Trace (Destructive)

**Method:**
- Locate ROMCS signal trace on motherboard
- Cut trace between DRAM/DMA Control IC and ROM chips
- ROM never receives chip select signal
- E000 becomes unmapped memory

**Pros:**
- Simple physical modification
- Permanent solution

**Cons:**
- **IRREVERSIBLE** (cannot restore ROM drive)
- Requires opening case and precise trace cutting
- May affect system BIOS at F000 if trace shared
- Risk of damaging motherboard

### Solution 2: Lift ROMCS Pin on ROM Chips

**Method:**
- Carefully bend ROMCS pin on ROM chips (U54-U57) away from socket
- ROM chips never receive chip select
- E000 becomes unmapped

**Pros:**
- Reversible (can resolder pin)
- ROM chips unaffected

**Cons:**
- Requires desoldering/resoldering ROM chips
- Risk of damaging ROM chips
- All 4 ROM chips must be modified
- Tricky on old hardware

### Solution 3: Add ROMCS Override Circuit

**Method:**
- Insert GAL/PAL between DRAM/DMA IC and ROM chips
- GAL monitors Port FFEA writes
- When "disable" command written to Port FFEA, GAL blocks ROMCS
- Requires external hardware

**Pros:**
- Software controllable
- Reversible
- Can toggle ROM on/off as needed

**Cons:**
- Requires custom GAL programming
- Complex circuit design
- Must intercept ROMCS trace
- Need GAL programmer

### Solution 4: Replace DRAM/DMA Control IC

**Method:**
- Replace memory controller with custom FPGA/CPLD
- Reprogram logic to make ROMCS controllable via Port FFEA
- Ultimate flexibility

**Pros:**
- Complete control
- Can add features

**Cons:**
- **EXTREMELY DIFFICULT**
- Need to reverse engineer entire memory controller
- Source/create compatible replacement chip
- High risk of making system unusable

### Solution 5: Shadow ROM to RAM, Disable ROM

**Method:**
- Add circuitry to:
  1. Copy ROM contents to RAM during POST
  2. Physically disable ROMCS after copy
  3. CPU reads from RAM instead of ROM at E000

**Pros:**
- ROM drive functionality preserved (data in RAM)
- E000 becomes RAM
- Can be done with simple logic

**Cons:**
- Complex circuit
- Need additional RAM for shadow
- Slow boot (must copy 512KB)

## Recommended Action: ABANDON SOFTWARE APPROACH

### Reality Check

The project goal was:
> "Provide a DOS device driver to disable ROM at E000:0000 to free memory for UMBs"

**This goal is IMPOSSIBLE on Tandy 1000 TL/2 hardware.**

The ROM-to-E000 mapping is:
- ✗ NOT controlled by Port FFEA
- ✗ NOT controlled by BIOS code
- ✗ NOT controlled by any software mechanism
- ✓ **HARDWIRED in the memory controller chip**

### What We Learned

1. **Port FFEA** controls ROM page selection (which 64KB page is visible)
2. **ROMCS** is generated by address decode logic (activates ROM chips)
3. **Address decode is HARDWIRED** (cannot be changed without hardware mod)
4. **BIOS cannot disable ROM** (it's below BIOS in the hardware stack)
5. **The handwritten note was wrong** (bit 4 doesn't disable ROM)

### Options Going Forward

**Option A: Document Findings and Close Project**
- Update README with conclusion
- Document why software solution is impossible
- Provide hardware modification instructions for brave users
- Mark project as "HARDWARE LIMITATION CONFIRMED"

**Option B: Pivot to Hardware Modification Guide**
- Design ROMCS cutoff circuit
- Create detailed trace-cutting guide
- Provide GAL-based solution schematics
- Test on hardware and document results

**Option C: Explore Alternative Memory Expansion**
- ISA card with RAM at E000?
- Different memory management strategies
- Accept 64KB less UMB space

## Technical Documentation for Future Reference

### Memory Map (Confirmed):
```
Address Range          ROMCS    Content
0x000000-0x09FFFF      NO       Conventional RAM (640KB)
0x0A0000-0x0BFFFF      NO       Video RAM
0x0C0000-0x0DFFFF      NO       Adapter ROM/RAM
0x0E0000-0x0FFFFF      YES      ROM Page Frame (E000-EFFF) ← BLOCKED
0x100000+              NO       Extended memory (if 286)
```

### DRAM/DMA Control IC (U22):
- Custom Tandy chip
- Generates ROMCS, RAS, CAS, MEMCYC signals
- Address decode logic for ROM ranges
- NOT user-configurable
- NOT software-controllable

### Port FFEA Register:
```
Bit 0-3: ROM Page (0-7) - Selects which 64KB page from 512KB ROM
Bit 4:   System detection (inverts on TL/2, not TL)
Bit 5:   System type detection
Bit 6-7: Memory configuration (512K/640K)
```

**Port FFEA does NOT control ROMCS enable/disable!**

## Conclusion

The Tandy 1000 TL/2 ROM at E000:0000 **CANNOT be disabled via software**.

The ROM mapping is hardwired in the memory controller's address decode logic and will always respond to E000-EFFF addresses. No Port FFEA value, BIOS modification, or DOS driver can change this fundamental hardware architecture.

**The project goal of creating NOROM.SYS is technically impossible.**

To free E000 for UMBs requires **physical hardware modification** to cut or override the ROMCS signal.
